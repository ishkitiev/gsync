#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="${GSYNC_PRESETS:-$HOME/.config/gsync/presets.conf}"

# --- colors (disable if not a TTY) ---
if [[ -t 1 ]]; then
  C_RESET=$'\033[0m'
  C_BOLD=$'\033[1m'
  C_RED=$'\033[31m'
  C_GREEN=$'\033[32m'
  C_YELLOW=$'\033[33m'
  C_BLUE=$'\033[34m'
else
  C_RESET=""; C_BOLD=""; C_RED=""; C_GREEN=""; C_YELLOW=""; C_BLUE=""
fi

# --- UTF-8 icons (fallback-safe) ---
if locale 2>/dev/null | grep -qi "UTF-8"; then
  ICON_OK="✔"
  ICON_WARN="⚠"
  ICON_ERR="✖"
else
  ICON_OK="[OK]"
  ICON_WARN="[!]"
  ICON_ERR="[X]"
fi

usage() {
  cat <<EOF
Usage:
  gsync-menu [--host IP] [--user USER] [-y|--yes] [--config FILE]

Reads presets from:
  $CONFIG_FILE

Preset format (one per line):
  DESCRIPTION|LOCAL_DESTINATION|REMOTE_SOURCE

Example:
  Movies|/backup/movies|/mnt/nvme/movies/

EOF
  exit 1
}

HOST=""
USER_OPT=""
YES_OPT=""
CUSTOM_CONFIG=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --host) HOST="$2"; shift 2 ;;
    --user) USER_OPT="$2"; shift 2 ;;
    -y|--yes) YES_OPT="--yes"; shift ;;
    --config) CUSTOM_CONFIG="$2"; shift 2 ;;
    -h|--help) usage ;;
    *) echo "${C_RED}${C_BOLD}Unknown argument:${C_RESET} $1"; usage ;;
  esac
done

if [[ -n "$CUSTOM_CONFIG" ]]; then
  CONFIG_FILE="$CUSTOM_CONFIG"
fi

if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "${C_RED}${C_BOLD}Presets file not found:${C_RESET} $CONFIG_FILE"
  echo "Create it with lines like:"
  echo "  Description|/local/target|/remote/source/"
  exit 2
fi

mapfile -t LINES < <(grep -v '^[[:space:]]*$' "$CONFIG_FILE" | grep -v '^[[:space:]]*#')

if [[ ${#LINES[@]} -eq 0 ]]; then
  echo "${C_YELLOW}No presets found in:${C_RESET} $CONFIG_FILE"
  exit 0
fi

trim() {
  local s="$1"
  s="${s#"${s%%[![:space:]]*}"}"
  s="${s%"${s##*[![:space:]]}"}"
  printf '%s' "$s"
}

declare -a DESC LOCAL REMOTE
for line in "${LINES[@]}"; do
  IFS='|' read -r d l r <<<"$line"
  d="$(trim "${d:-}")"
  l="$(trim "${l:-}")"
  r="$(trim "${r:-}")"
  [[ -z "$d" || -z "$l" || -z "$r" ]] && continue
  DESC+=("$d")
  LOCAL+=("$l")
  REMOTE+=("$r")
done

if [[ ${#DESC[@]} -eq 0 ]]; then
  echo "${C_YELLOW}No valid presets found in:${C_RESET} $CONFIG_FILE"
  exit 0
fi

get_last_sync_info() {
  # Args: local_dest
  # Output: "<color>|<icon>|<last_iso>|<age_text>"
  local dest="$1"
  local log_file="${dest}/last_sync.log"

  local last_iso="never"
  local age_text="never"
  local color="$C_RED"
  local icon="$ICON_ERR"

  if [[ -f "$log_file" ]]; then
    local line
    line="$(grep "^End:" "$log_file" | tail -n 1 || true)"
    if [[ -n "$line" ]]; then
      last_iso="$(echo "$line" | awk '{print $2}')"

      local last_epoch now_epoch diff_days
      last_epoch="$(date -d "$last_iso" +%s 2>/dev/null || echo 0)"
      now_epoch="$(date +%s)"

      if [[ "$last_epoch" -gt 0 ]]; then
        diff_days=$(( (now_epoch - last_epoch) / 86400 ))

        if (( diff_days <= 0 )); then
          color="$C_GREEN"; icon="$ICON_OK"; age_text="today"
        elif (( diff_days == 1 )); then
          color="$C_YELLOW"; icon="$ICON_WARN"; age_text="1 day ago"
        elif (( diff_days <= 7 )); then
          color="$C_YELLOW"; icon="$ICON_WARN"; age_text="${diff_days} days ago"
        else
          color="$C_RED"; icon="$ICON_ERR"; age_text="${diff_days} days ago"
        fi
      else
        # Unparseable date
        color="$C_YELLOW"; icon="$ICON_WARN"; age_text="unknown age"
      fi
    fi
  fi

  printf '%s|%s|%s|%s' "$color" "$icon" "$last_iso" "$age_text"
}

echo
echo "${C_BLUE}${C_BOLD}gsync-menu — stored presets${C_RESET}"
echo

# Determine alignment width for nicer output (no over-pudering)
max_desc=0
for d in "${DESC[@]}"; do
  (( ${#d} > max_desc )) && max_desc=${#d}
done
(( max_desc > 60 )) && max_desc=60  # cap to avoid huge padding

for i in "${!DESC[@]}"; do
  info="$(get_last_sync_info "${LOCAL[$i]}")"
  IFS='|' read -r color icon last_iso age_text <<<"$info"

  # Pad description to align status column
  d="${DESC[$i]}"
  if (( ${#d} > max_desc )); then
    d="${d:0:max_desc-3}..."
  fi
  printf "  %2s) %-*s  %s%s%s %s[Last: %s | %s]%s\n" \
    "$((i+1))" \
    "$max_desc" "$d" \
    "$color$C_BOLD" "$icon" "$C_RESET" \
    "$color$C_BOLD" "$last_iso" "$age_text" "$C_RESET"
done

echo
read -rp "Choose preset number (or 'q' to quit): " choice
if [[ "$choice" == "q" || "$choice" == "Q" ]]; then
  echo "${C_YELLOW}Aborted.${C_RESET}"
  exit 0
fi
if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
  echo "${C_RED}${C_BOLD}Invalid choice.${C_RESET}"
  exit 3
fi

idx=$((choice - 1))
if (( idx < 0 || idx >= ${#DESC[@]} )); then
  echo "${C_RED}${C_BOLD}Choice out of range.${C_RESET}"
  exit 4
fi

dest="${LOCAL[$idx]}"
src="${REMOTE[$idx]}"

mkdir -p "$dest"
cd "$dest"

ARGS=()
[[ -n "$HOST" ]] && ARGS+=(--host "$HOST")
[[ -n "$USER_OPT" ]] && ARGS+=(--user "$USER_OPT")
[[ -n "$YES_OPT" ]] && ARGS+=("$YES_OPT")

echo
echo "${C_GREEN}${C_BOLD}Selected:${C_RESET} ${DESC[$idx]}"
echo "${C_BOLD}Local target:${C_RESET} $dest"
echo "${C_BOLD}Remote source:${C_RESET} $src"
echo

exec gsync "$src" "${ARGS[@]}"
